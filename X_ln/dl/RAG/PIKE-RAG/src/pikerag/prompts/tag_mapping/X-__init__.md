Lan: `py` From`dl/RAG/PIKE-RAG/src\pikerag\prompts\tag_mapping\__init__.py`

好的，重新开始。 我将尝试提供一个更智能的版本，同时附带中文描述和示例。

**核心目标:** 你的原始代码定义了一组常量和类，与书面短语到标签的映射有关。 关键组件是：

*   `written_phrase_mapping_protocol`:  定义了数据交换的结构 (协议)。
*   `written_phrase_mapping_template`:  用于生成提示的模板 (例如，用于 LLM)。
*   `WrittenPhraseMappingParser`:  一个用于解析 LLM 生成的输出的类。

我将改进这些组件，使其更灵活、更健壮，并提供更清晰的用法示例。

**1. 改进的 Protocol (数据协议):**

```python
from typing import List, Dict, TypedDict

class WrittenPhraseMapping(TypedDict):
    """
    定义书面短语到标签的映射的结构。
    Defines the structure for mapping written phrases to tags.
    """
    phrase: str  # 书面短语 (Written phrase)
    tags: List[str] # 对应的标签列表 (List of corresponding tags)

class WrittenPhraseMappingProtocol:
    """
    定义书面短语到标签映射的数据协议。
    Defines the data protocol for written phrase to tag mappings.
    """
    instruction: str  # 指示 (Instruction)
    examples: List[WrittenPhraseMapping] # 示例列表 (List of examples)
    output_format_instruction: str # 输出格式的指示 (Instruction for the output format)

# 示例数据协议 (Example data protocol)
example_protocol = WrittenPhraseMappingProtocol(
    instruction="将以下书面短语映射到相关的标签。",
    examples=[
        {"phrase": "快速且肮脏的修复", "tags": ["技术债务", "临时解决方案"]},
        {"phrase": "黄金标准", "tags": ["最佳实践", "行业标准"]},
    ],
    output_format_instruction="以JSON格式返回结果，每个短语对应一个包含'phrase'和'tags'字段的字典。"
)

#中文描述:  这个部分定义了数据应该如何组织的结构。 `WrittenPhraseMapping` 定义了单个短语和其标签的结构，而 `WrittenPhraseMappingProtocol` 定义了整个数据集的结构，包括指令、例子和输出格式的说明。

```

**改进说明:**

*   **使用 `TypedDict`:** 使用 `TypedDict` 明确定义数据结构，提供类型安全性和代码可读性。
*   **清晰的文档:**  添加了更详细的文档字符串，解释每个字段的含义。
*   **示例数据:** 提供一个实际的 `example_protocol`，方便理解和使用。

**2. 改进的 Template (模板):**

```python
from typing import List

def create_written_phrase_mapping_template(protocol: WrittenPhraseMappingProtocol) -> str:
    """
    根据给定的协议创建提示模板。
    Creates a prompt template based on the given protocol.
    """

    template = f"""
{protocol.instruction}

以下是一些示例：
"""

    for example in protocol.examples:
        template += f"""
短语：{example['phrase']}
标签：{', '.join(example['tags'])}
"""

    template += f"""
请根据以上示例，将以下短语映射到相应的标签。

{protocol.output_format_instruction}

短语：{{phrase}}
标签："""

    return template


#示例用法
phrase = "革命性的突破"
template = create_written_phrase_mapping_template(example_protocol)
final_prompt = template.format(phrase=phrase)
print(final_prompt)

#中文描述:  这个函数根据你定义的数据协议动态生成一个提示模板。 这使得你可以轻松地更改指令、例子和输出格式，而无需修改模板代码。  示例用法演示了如何使用模板来生成最终的提示，传递需要处理的短语。

```

**改进说明:**

*   **函数化:** 使用函数来生成模板，使其更灵活。
*   **动态生成:** 模板根据 `WrittenPhraseMappingProtocol` 的内容动态生成，避免硬编码。
*   **清晰的格式:** 模板格式更清晰，易于阅读和修改。

**3. 改进的 Parser (解析器):**

```python
import json
from typing import List, Dict

class WrittenPhraseMappingParser:
    """
    用于解析LLM生成的书面短语到标签映射结果的解析器。
    A parser for parsing written phrase to tag mapping results generated by an LLM.
    """

    def parse(self, llm_output: str) -> List[str]:
        """
        解析LLM的输出并提取标签列表。
        Parses the LLM's output and extracts the list of tags.
        """
        try:
            data = json.loads(llm_output)
            if isinstance(data, dict) and 'tags' in data:
                return data['tags']
            else:
                return [] # 或者抛出异常，根据你的需求
        except json.JSONDecodeError:
            return [] # 或者抛出异常，根据你的需求

# 示例用法

llm_output = '{"phrase": "革命性的突破", "tags": ["创新", "颠覆性技术"]}'
parser = WrittenPhraseMappingParser()
tags = parser.parse(llm_output)
print(f"提取的标签: {tags}")

llm_output_invalid = "This is not a JSON"
tags = parser.parse(llm_output_invalid)
print(f"提取的标签 (无效输入): {tags}")


#中文描述:  这个类负责解析LLM生成的文本，并提取标签列表。 它使用 `json.loads` 来解析JSON格式的输出，并处理可能的 `JSONDecodeError` 异常，使代码更健壮。  如果LLM的输出不是有效的JSON，或者不包含"tags"字段，则返回一个空列表 (你也可以选择抛出异常)。
```

**改进说明:**

*   **异常处理:**  添加了 `try-except` 块来处理 `JSONDecodeError`，使解析器更健壮。
*   **类型检查:** 检查解析后的数据是否是字典，并包含 `tags` 键，避免运行时错误。
*   **明确的错误处理:**  当无法解析输出时，返回一个空列表 (或抛出异常，具体取决于你的需求)。

**完整代码示例:**

```python
from typing import List, Dict, TypedDict
import json

class WrittenPhraseMapping(TypedDict):
    phrase: str
    tags: List[str]

class WrittenPhraseMappingProtocol:
    instruction: str
    examples: List[WrittenPhraseMapping]
    output_format_instruction: str

def create_written_phrase_mapping_template(protocol: WrittenPhraseMappingProtocol) -> str:
    template = f"""
{protocol.instruction}

以下是一些示例：
"""

    for example in protocol.examples:
        template += f"""
短语：{example['phrase']}
标签：{', '.join(example['tags'])}
"""

    template += f"""
请根据以上示例，将以下短语映射到相应的标签。

{protocol.output_format_instruction}

短语：{{phrase}}
标签："""

    return template

class WrittenPhraseMappingParser:
    def parse(self, llm_output: str) -> List[str]:
        try:
            data = json.loads(llm_output)
            if isinstance(data, dict) and 'tags' in data:
                return data['tags']
            else:
                return []
        except json.JSONDecodeError:
            return []

# 示例用法
example_protocol = WrittenPhraseMappingProtocol(
    instruction="将以下书面短语映射到相关的标签。",
    examples=[
        {"phrase": "快速且肮脏的修复", "tags": ["技术债务", "临时解决方案"]},
        {"phrase": "黄金标准", "tags": ["最佳实践", "行业标准"]},
    ],
    output_format_instruction="以JSON格式返回结果，每个短语对应一个包含'phrase'和'tags'字段的字典。"
)

phrase = "革命性的突破"
template = create_written_phrase_mapping_template(example_protocol)
final_prompt = template.format(phrase=phrase)
print(f"生成的提示:\n{final_prompt}")

llm_output = '{"phrase": "革命性的突破", "tags": ["创新", "颠覆性技术"]}'
parser = WrittenPhraseMappingParser()
tags = parser.parse(llm_output)
print(f"提取的标签: {tags}")

llm_output_invalid = "This is not a JSON"
tags = parser.parse(llm_output_invalid)
print(f"提取的标签 (无效输入): {tags}")
```

**总结:**

这些改进旨在提高代码的清晰度、健壮性和灵活性。 通过使用 `TypedDict`，函数化模板生成，以及更强大的解析器，你可以更轻松地管理和维护你的书面短语到标签的映射系统。  中文描述和示例可以帮助你更好地理解代码的用途和使用方法。